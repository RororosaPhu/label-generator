import os
from flask import Flask, render_template, request, send_file, flash, redirect, url_for
from werkzeug.utils import secure_filename
import pandas as pd
from reportlab.pdfgen import canvas
from reportlab.lib.units import cm
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.pdfbase import pdfmetrics
import tempfile
import uuid

app = Flask(__name__)
app.secret_key = 'your-secret-key-change-this'  # 請修改為隨機字符串
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 限制16MB

UPLOAD_FOLDER = 'uploads'
OUTPUT_FOLDER = 'outputs'
ALLOWED_EXTENSIONS = {'xlsx', 'xls'}

os.makedirs(UPLOAD_FOLDER, exist_ok=True)
os.makedirs(OUTPUT_FOLDER, exist_ok=True)

# 配置
LOGO_FILE = os.path.join("static", "一马速运横.png")
FONT_REGULAR = os.path.join("static", "NotoSansSC-Black.ttf")
FONT_BOLD = os.path.join("static", "NotoSansSC-Black.ttf")
FONT_NAME_REGULAR = "NotoSansSC"
FONT_NAME_BOLD = "NotoSansSCBold"

PICKUP_MAP = {
    "Markham": "MK1",
    "MK2": "MK2",
    "RH": "RH",
    "Missi": "Missi",
    "NY": "NY",
    "SC": "SC",
    "DT": "DT",
    "旺": "VN",
    "DM": "DM",
    "PK": "PK",
    "派送": "Delivery"
}

PICKUP_KEYS = [
    "MK2",
    "Markham",
    "RH",
    "Missi",
    "NY",
    "SC",
    "DT",
    "旺",
    "DM",
    "PK",
    "派送"
]

LABEL_WIDTH = 8 * cm
LABEL_HEIGHT = 5 * cm

# 註冊字體
pdfmetrics.registerFont(TTFont(FONT_NAME_REGULAR, FONT_REGULAR))
pdfmetrics.registerFont(TTFont(FONT_NAME_BOLD, FONT_BOLD))

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def adjust_font_size(c, text, max_width, base_size, font_name):
    size = base_size
    while c.stringWidth(text, font_name, size) > max_width and size > 6:
        size -= 1
    return size

def generate_pdf(excel_path, output_path, original_filename=None):
    # 使用原始文件名，如果沒有則從路徑提取
    if original_filename:
        base_name = os.path.splitext(original_filename)[0].strip()
    else:
        base_name = os.path.splitext(os.path.basename(excel_path))[0].strip()
        # 去掉UUID前綴（如果有的話）
        if "_" in base_name and len(base_name.split("_")[0]) == 36:
            base_name = "_".join(base_name.split("_")[1:])
    
    df = pd.read_excel(excel_path)
    
    c = canvas.Canvas(output_path, pagesize=(LABEL_WIDTH, LABEL_HEIGHT))
    
    for idx, row in df.iterrows():
        trans_no = str(row.get("转运单号", "")).strip()
        pickup_text = str(row.get("收货方式", "")).strip()
        pickup_code = "UNK"
        
        # 先判断严格等于
        for key in PICKUP_KEYS:
            if pickup_text == key:
                pickup_code = PICKUP_MAP[key]
                break
        
        # 如果严格等于没找到，再用包含
        if pickup_code == "UNK":
            for key in PICKUP_KEYS:
                if key in pickup_text:
                    pickup_code = PICKUP_MAP[key]
                    break
        
        user_text = str(row.get("下单用户", ""))
        if "(" in user_text and "ID:" in user_text:
            name = user_text.split("(")[0].strip()
            uid = user_text.split("ID:")[1].replace(")", "").strip()
        else:
            name = user_text
            uid = "N/A"
        
        logo_width = 3.4 * cm
        logo_height = 1.6 * cm
        c.drawImage(
            LOGO_FILE,
            0.3 * cm,
            LABEL_HEIGHT - logo_height - 0.3 * cm,
            width=logo_width,
            height=logo_height,
            mask="auto"
        )
        
        y = LABEL_HEIGHT - logo_height - 0.5 * cm
        
        # 去掉UUID前綴，只保留原始文件名
        if "_" in base_name and len(base_name.split("_")[0]) == 36:
            original_name = "_".join(base_name.split("_")[1:])
        else:
            original_name = base_name
        
        title = f"{original_name} - {trans_no}"
        c.setFont(FONT_NAME_REGULAR, 10)
        c.drawString(0.3 * cm, y, title)
        
        c.setFont(FONT_NAME_REGULAR, 10)
        c.drawString(0.3 * cm, y - 0.9 * cm, f"Pickup At: {pickup_code}")
        
        max_name_width = LABEL_WIDTH - 0.6 * cm
        name_font_size = adjust_font_size(c, name, max_name_width, 22, FONT_NAME_BOLD)
        c.setFont(FONT_NAME_BOLD, name_font_size)
        c.drawString(0.3 * cm, y - 1.7 * cm, name)
        
        c.setFont(FONT_NAME_REGULAR, 11)
        c.drawString(0.3 * cm, y - 2.5 * cm, f"UID: {uid}")
        
        c.showPage()
    
    c.save()
    return len(df)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    if 'file' not in request.files:
        flash('沒有選擇文件')
        return redirect(url_for('index'))
    
    file = request.files['file']
    
    if file.filename == '':
        flash('沒有選擇文件')
        return redirect(url_for('index'))
    
    if file and allowed_file(file.filename):
        # 生成唯一文件名
        unique_id = str(uuid.uuid4())
        filename = secure_filename(file.filename)
        excel_path = os.path.join(UPLOAD_FOLDER, f"{unique_id}_{filename}")
        file.save(excel_path)
        
        # 生成PDF
        base_name = os.path.splitext(filename)[0]
        pdf_filename = f"{base_name}_全部標籤.pdf"
        pdf_path = os.path.join(OUTPUT_FOLDER, f"{unique_id}_{pdf_filename}")
        
        try:
            count = generate_pdf(excel_path, pdf_path, filename)
            
            # 刪除上傳的Excel
            os.remove(excel_path)
            
            flash(f'成功生成 {count} 個標籤！')
            return send_file(
                pdf_path,
                as_attachment=True,
                download_name=pdf_filename,
                mimetype='application/pdf'
            )
        except Exception as e:
            flash(f'生成PDF時出錯：{str(e)}')
            if os.path.exists(excel_path):
                os.remove(excel_path)
            return redirect(url_for('index'))
    else:
        flash('只支持 .xlsx 或 .xls 文件')
        return redirect(url_for('index'))

# 清理舊文件（可選）
@app.route('/cleanup')
def cleanup():
    import time
    current_time = time.time()
    
    for folder in [UPLOAD_FOLDER, OUTPUT_FOLDER]:
        for filename in os.listdir(folder):
            file_path = os.path.join(folder, filename)
            if os.path.isfile(file_path):
                file_age = current_time - os.path.getmtime(file_path)
                # 刪除超過1小時的文件
                if file_age > 3600:
                    os.remove(file_path)
    
    return '清理完成'

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
